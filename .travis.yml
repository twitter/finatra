# container-based build
sudo: false

language: scala

git:
  quiet: true # (default = false)
  depth: 5 # (default = 50)

env:
  global:
    - JAVA_OPTS="-DSKIP_FLAKY=true -Dsbt.log.noformat=true"

# These directories are cached to S3 at the end of the build
cache:
  timeout: 300 # seconds = 5 mins (default = 3 mins)
  directories:
   - $HOME/.ivy2
   - $HOME/.sbt/boot/scala-$TRAVIS_SCALA_VERSION
   - $HOME/.dodo

before_cache:
  # Tricks to avoid unnecessary cache updates
  - find $HOME/.ivy2 -name "ivydata-*.properties" -delete
  - find $HOME/.sbt -name "*.lock" -delete

notifications:
  slack:
    secure: e3EryTvX8zFOFZzFJT9gXx7Hmi+1uBypAfgTZ20vJzKkq8GbcNjrAPyCNR39lGeB4Toij3ygvUiQFmsUy1neH0krVQ70TAZUVx06oZJh0urR5/E3wN/y5Zx09uywXZf1daBVZ26kBVO53kF8pkYXGI2sczofIXj25LRV0w7G22I=

stages:
  - dodo
  - test

jobs:
  include:
    - stage: dodo
      jdk: oraclejdk8
      script: curl -s https://raw.githubusercontent.com/twitter/dodo/develop/bin/build | bash -s -- --no-test finatra
    - stage: test
      jdk: oraclejdk8
      scala: 2.11.12
      env:
        - PROJECT=benchmarks
        - PROJECT=http
        - PROJECT=httpclient
        - PROJECT=injectApp
        - PROJECT=injectCore
        - PROJECT=injectLogback
        - PROJECT=injectModules
        - PROJECT=injectRequestScope
        - PROJECT=injectServer
        - PROJECT=injectSlf4j
        - PROJECT=injectThrift
        - PROJECT=injectThriftClient
        - PROJECT=injectThriftClientHttpMapper
        - PROJECT=injectUtils
        - PROJECT=jackson
        - PROJECT=thrift
        - PROJECT=utils
        # examples
        - PROJECT=benchmarkServer
        - PROJECT=exampleHttpJavaServer
        - PROJECT=exampleInjectJavaServer
        - PROJECT=exampleTwitterServer
        - PROJECT=exampleWebDashboard
        - PROJECT=helloWorld
        - PROJECT=streamingExample
        - PROJECT=thriftExampleServer
        - PROJECT=thriftJavaExampleServer
        - PROJECT=twitterClone
      before_script: unset SBT_OPTS # default $SBT_OPTS is irrelevant to sbt launcher
      script: 
        - travis_retry ./sbt ++$TRAVIS_SCALA_VERSION coverage "$PROJECT/test" coverageReport
        - ./sbt ++$TRAVIS_SCALA_VERSION coverageAggregate
      after_success:
        - bash <(curl -s https://codecov.io/bash)
    - stage: test
      jdk: oraclejdk8
      scala: 2.12.6
      env:
        - PROJECT=benchmarks
        - PROJECT=http
        - PROJECT=httpclient
        - PROJECT=injectApp
        - PROJECT=injectCore
        - PROJECT=injectLogback
        - PROJECT=injectModules
        - PROJECT=injectRequestScope
        - PROJECT=injectServer
        - PROJECT=injectSlf4j
        - PROJECT=injectThrift
        - PROJECT=injectThriftClient
        - PROJECT=injectThriftClientHttpMapper
        - PROJECT=injectUtils
        - PROJECT=jackson
        - PROJECT=thrift
        - PROJECT=utils
        # examples
        - PROJECT=benchmarkServer
        - PROJECT=exampleHttpJavaServer
        - PROJECT=exampleInjectJavaServer
        - PROJECT=exampleTwitterServer
        - PROJECT=exampleWebDashboard
        - PROJECT=helloWorld
        - PROJECT=streamingExample
        - PROJECT=thriftExampleServer
        - PROJECT=thriftJavaExampleServer
        - PROJECT=twitterClone
      before_script: unset SBT_OPTS # default $SBT_OPTS is irrelevant to sbt launcher
      script: 
        - travis_retry ./sbt ++$TRAVIS_SCALA_VERSION coverage "$PROJECT/test" coverageReport
        - ./sbt ++$TRAVIS_SCALA_VERSION coverageAggregate
      after_success:
        - bash <(curl -s https://codecov.io/bash)
