
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>HTTP Streaming &#8212; Finatra 20.3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Message Body Components" href="message_body.html" />
    <link rel="prev" title="HTTP Responses" href="responses.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="message_body.html" title="Message Body Components"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="responses.html" title="HTTP Responses"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="http-streaming">
<span id="id1"></span><h1>HTTP Streaming<a class="headerlink" href="#http-streaming" title="Permalink to this headline">¶</a></h1>
<p>Finatra supports streaming over HTTP by defining the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/main/scala/com/twitter/finatra/http/streaming/StreamingRequest.scala">StreamingRequest</a> or a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http/src/main/scala/com/twitter/finatra/http/streaming/StreamingResponse.scala">StreamingResponse</a> request/response types. A <cite>StreamingRequest</cite>/<cite>StreamingResponse</cite> is an HTTP Request/Response that carries a stream of objects in its body. We support using either of our streaming primitives, <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/io/Reader.scala">Reader</a> or <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/concurrent/AsyncStream.scala">AsyncStream</a>, but we recommend using <cite>Reader</cite> as it has better support for resource management.</p>
<div class="section" id="features">
<h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The ability to program in terms of streams of domain objects instead of bytes. For example:</p>
<ul>
<li><p>A <cite>StreamingRequest</cite> will deserialize a valid JSON string to a domain object using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/json/internal/streaming/JsonStreamParser.scala">JsonStreamParser</a>.</p></li>
<li><p>A <cite>StreamingResponse</cite> will convert a domain object to a JSON string using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/json/FinatraObjectMapper.scala">ObjectMapper</a>.</p></li>
</ul>
</li>
<li><p>The ability to bypass the <cite>ObjectMappper</cite> and <cite>JsonStreamParser</cite> by dealing with streams of <cite>Buf</cite> directly.</p></li>
<li><p>The ability to perform resource management by using the signal from <cite>Reader#onClose</cite>.</p></li>
<li><p>The ability to perform composable operations over streams using <cite>map</cite> and <cite>flatMap</cite>.</p></li>
<li><p>Built-in <a class="reference external" href="https://docbird.twitter.biz/finagle/Metrics.html#streaming">streaming metrics</a> to gain more insights into a streams’ health.</p></li>
</ul>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Finatra streaming support lets controllers stream input, output, or both. By recognizing the input and output signatures of a handler as either a <cite>Reader</cite>, <cite>StreamingRequest</cite>, or <cite>StreamingResponse</cite>, Finatra will make the necessary conversions.</p>
<p><cite>StreamingRequest</cite> and <cite>StreamingResponse</cite> are fully featured Request/Response objects and allow you control over, and access to, request parameters and headers. If instead, you only need to consume or return data without having to inspect the request or modify the response, you can deal completely in terms of our streaming primitives.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.finatra.http.Controller</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.streaming.StreamingRequest</span>
<span class="k">import</span> <span class="nn">com.twitter.io.</span><span class="o">{</span><span class="nc">Buf</span><span class="o">,</span> <span class="nc">Reader</span><span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Tweet</span><span class="o">(</span><span class="n">text</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">MyTweetController</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>

  <span class="c1">// StreamingRequest[Reader, Tweet] =&gt; StreamingResponse[Reader, String]</span>
  <span class="n">post</span><span class="o">(</span><span class="s">&quot;/tweets/streaming/request/response&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">streamingRequest</span><span class="k">:</span> <span class="kt">StreamingRequest</span><span class="o">[</span><span class="kt">Reader</span><span class="p">,</span> <span class="kt">Tweet</span><span class="o">]</span> <span class="k">=&gt;</span>
    <span class="c1">// In this case we need to look at a specific header</span>
    <span class="k">val</span> <span class="n">specialHeader</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">streamingRequest</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headerMap</span><span class="o">(</span><span class="s">&quot;Special-Header&quot;</span><span class="o">)</span>
    <span class="c1">// Grab the input stream and do some work with it</span>
    <span class="k">val</span> <span class="n">responseReader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">streamingRequest</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="n">specialHeader</span><span class="o">)</span>
    <span class="c1">// create a `StreamingResponse` via `ResponseBuilder` with our special header</span>
    <span class="n">response</span><span class="o">.</span><span class="n">streaming</span><span class="o">(</span><span class="n">responseReader</span><span class="o">,</span> <span class="n">headers</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;Special-Header&quot;</span> <span class="o">-&gt;</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;Thank you!&quot;</span><span class="o">)))</span>
  <span class="o">}</span>

  <span class="c1">// Reader[Tweet] =&gt; StreamingResponse[Reader, String]</span>
  <span class="n">post</span><span class="o">(</span><span class="s">&quot;/tweets/streaming/reader/response&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">tweetReader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="k">=&gt;</span>
    <span class="c1">// Grab the input stream and do some work with it</span>
    <span class="k">val</span> <span class="n">responseReader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">tweetReader</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">text</span><span class="o">)</span>
    <span class="c1">// create a `StreamingResponse` via `ResponseBuilder` with our special header</span>
    <span class="n">response</span><span class="o">.</span><span class="n">streaming</span><span class="o">(</span><span class="n">responseReader</span><span class="o">,</span> <span class="n">headers</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;Special-Header&quot;</span> <span class="o">-&gt;</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;Thank you!&quot;</span><span class="o">)))</span>
  <span class="o">}</span>

  <span class="c1">// Reader[Tweet] =&gt; Reader[String]</span>
  <span class="n">post</span><span class="o">(</span><span class="s">&quot;/tweets/streaming/reader/reader&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">tweetReader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="k">=&gt;</span>
    <span class="c1">// Grab the tweets, do some work with them and return the result</span>
    <span class="n">tweetReader</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">text</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// Reader[Buf] =&gt; Reader[Buf]</span>
  <span class="n">post</span><span class="o">(</span><span class="s">&quot;/tweets/streaming/reader/reader/bytes&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">byteReader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">Buf</span><span class="o">]</span> <span class="k">=&gt;</span>
    <span class="c1">// Grab the raw bytes, do some work with them and return the result</span>
    <span class="n">byteReader</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">bytes</span> <span class="k">=&gt;</span> <span class="nc">Buf</span><span class="o">.</span><span class="nc">Utf8</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toString</span> <span class="o">+</span> <span class="s">&quot;hi&quot;</span><span class="o">))</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Resource management is performed by listening to <cite>Reader#onClose</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.finatra.http.streaming.StreamingRequest</span>
<span class="k">import</span> <span class="nn">com.twitter.io.Reader</span>
<span class="k">import</span> <span class="nn">com.twitter.util.Closable</span>

<span class="k">trait</span> <span class="nc">Resource</span> <span class="k">extends</span> <span class="nc">Closable</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">lookup</span><span class="o">(</span><span class="n">test</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">MyOtherTweetController</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">closableResource</span><span class="o">()</span><span class="k">:</span> <span class="kt">Resource</span> <span class="o">=</span> <span class="o">???</span>

  <span class="n">post</span><span class="o">(</span><span class="s">&quot;/tweets/streaming/reader_with_resource_management&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">streamingRequest</span><span class="k">:</span> <span class="kt">StreamingRequest</span><span class="o">[</span><span class="kt">Reader</span><span class="p">,</span> <span class="kt">Tweet</span><span class="o">]</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">resource</span> <span class="k">=</span> <span class="n">closableResource</span><span class="o">()</span>

      <span class="c1">// create a `Reader` with any object types to pass to the `StreamingResponse`</span>
      <span class="k">val</span> <span class="n">responseReader</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">streamingRequest</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span>
        <span class="n">tweet</span> <span class="k">=&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">lookup</span><span class="o">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">text</span><span class="o">)</span>
      <span class="o">)</span>

      <span class="c1">// close the resource after `reader#onClose` is resolved</span>
      <span class="n">responseReader</span><span class="o">.</span><span class="n">onClose</span><span class="o">.</span><span class="n">ensure</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="n">close</span><span class="o">())</span>

      <span class="c1">// create a `StreamingResponse` via `ResponseBuilder`</span>
      <span class="n">response</span><span class="o">.</span><span class="n">streaming</span><span class="o">(</span><span class="n">responseReader</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You can check out more streaming examples from <a class="reference external" href="https://github.com/twitter/finatra/tree/develop/examples/streaming-example">Finatra examples</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">HTTP Streaming</a><ul>
<li><a class="reference internal" href="#features">Features</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="responses.html" title="previous chapter">HTTP Responses</a></li>
      <li>Next: <a href="message_body.html" title="next chapter">Message Body Components</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2020 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>