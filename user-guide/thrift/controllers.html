<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Defining Thrift Controllers &#8212; Finatra User&#39;s Guide 2.13.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Finatra User&#39;s Guide 2.13.0 documentation" href="../index.html" />
    <link rel="next" title="Filtering Thrift Requests" href="filters.html" />
    <link rel="prev" title="Thrift Server Definition" href="server.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head>
  <body role="document">
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="filters.html" title="Filtering Thrift Requests"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="server.html" title="Thrift Server Definition"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finatra</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="defining-thrift-controllers">
<span id="thrift-controllers"></span><h1>Defining Thrift Controllers<a class="headerlink" href="#defining-thrift-controllers" title="Permalink to this headline">¶</a></h1>
<p>A <em>Thrift Controller</em> is an implementation of your thrift service. To create the controller, extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/Controller.scala">c.t.finatra.thrift.Controller</a> trait and mix-in the <a class="reference external" href="https://twitter.github.io/scrooge/">Scrooge</a>-generated <cite>BaseServiceIface</cite> trait for your service. Scrooge generates a <cite>ServiceIface</cite> which is a case class containing a <cite>Service</cite> for each thrift method over the corresponding <cite>Args</cite> and <cite>SuccessType</cite> structures for the method that extends from the <cite>BaseServiceIface</cite> trait. E.g,</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>case class ServiceIface(
  fetchBlob: Service[FetchBlob.Args, FetchBlob.SuccessType]
) extends BaseServiceIface
</pre></div>
</div>
<p>For Thrift Controllers we use the <cite>BaseServiceIface</cite> trait since we are not able to extend the <cite>ServiceIface</cite> case class.</p>
<div class="section" id="handle-thriftmethod-dsl">
<h2><cite>handle(ThriftMethod)</cite> DSL<a class="headerlink" href="#handle-thriftmethod-dsl" title="Permalink to this headline">¶</a></h2>
<p>The Finatra <cite>c.t.finatra.thrift.Controller</cite> provides a DSL with which you can easily implement your thrift service methods via the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/Controller.scala#L12">handle(ThriftMethod)</a> function which takes a callback from <cite>ThriftMethod.Args =&gt; Future[ThriftMethod.SuccessType]</cite>.</p>
<p>For example, given the following thrift IDL: <cite>example_service.thrift</cite></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>namespace java com.twitter.example.thriftjava
#@namespace scala com.twitter.example.thriftscala
namespace rb ExampleService

include &quot;finatra-thrift/finatra_thrift_exceptions.thrift&quot;

service ExampleService {
  i32 add1(
    1: i32 num
  ) throws (
    1: finatra_thrift_exceptions.ServerError serverError,
    2: finatra_thrift_exceptions.UnknownClientIdError unknownClientIdError
    3: finatra_thrift_exceptions.NoClientIdError noClientIdError
  )
}
</pre></div>
</div>
<p>We can implement the following Thrift Controller:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import com.twitter.example.thriftscala.ExampleService
import com.twitter.finatra.thrift.Controller
import com.twitter.util.Future

class ExampleThriftController
  extends Controller
  with ExampleService.BaseServiceIface {

  override val add1 = handle(Add1) { args: Add1.Args =&gt;
    Future(args.num + 1)
  }
}
</pre></div>
</div>
<p>The <cite>handle(ThriftMethod)</cite> function may seem magical but it serves an important purpose. By implementing your service method via this function, it allows the framework to apply the configured filter chain defined in your <a class="reference external" href="../build-new-thrift-server#server-definition">server definition</a> to your method implementation (passed as the callback to <cite>handle(ThriftMethod)</cite>).</p>
<p>That is to say, the <cite>handle(ThriftMethod)</cite> function captures your method implementation then exposes it for the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/routing/ThriftRouter.scala">ThriftRouter</a> to combine with the configured filter chain to build the <a class="reference external" href="https://twitter.github.io/finagle/guide/ServicesAndFilters.html">Finagle Service</a> that represents your server.</p>
<p>See the <a class="reference external" href="filters.html">Filters</a> section for more information on adding filters to your server definition.</p>
<p>Note, in the example above we implement the <cite>ExampleService.BaseServiceIface#add1</cite> method to satisfy the <cite>ExampleService.BaseServiceIface</cite> interface &#8211; however, the framework will not call the <cite>add1</cite> method in this way as it uses the implementation of the thrift method captured by the <cite>handle(ThriftMethod)</cite> function (as mentioned above this in order to apply the configured filter chain to requests). Thus if you were to directly call <cite>ExampleThriftController.add1(request)</cite> this would by-pass any configured <a class="reference external" href="filters.html">filters</a> from the server definition.</p>
</div>
<div class="section" id="ensure-you-override-using-val">
<h2>Ensure you override using <cite>val</cite><a class="headerlink" href="#ensure-you-override-using-val" title="Permalink to this headline">¶</a></h2>
<p>You will see above that we use <cite>override val</cite> since the computed <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/internal/ThriftMethodService.scala">ThriftMethodService</a> instance returned <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/Controller.scala#L19">is effectively constant</a>. However, you MUST override as a <cite>val</cite> when using the <cite>handle(ThriftMethod)</cite> function as using a <cite>def</cite> here will cause indeterminate behavior that will be hard to debug.</p>
</div>
<div class="section" id="add-the-controller-to-the-server">
<h2>Add the Controller to the Server<a class="headerlink" href="#add-the-controller-to-the-server" title="Permalink to this headline">¶</a></h2>
<p>As previously shown, the server can then be defined with this Thrift
Controller:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class ExampleServer extends ThriftServer {
  ...
  override def configureThrift(router: ThriftRouter): Unit = {
    router
      .add[ExampleThriftController]
  }
}
</pre></div>
</div>
<p>Please note that Finatra only currently supports adding a <strong>single</strong> Thrift controller to the <cite>ThriftRouter</cite>. The expectation is that you are implementing a single Thrift <em>service</em> and thus a single <cite>BaseServiceIface</cite> which is implementable in a single controller.</p>
</div>
<div class="section" id="but-i-don-t-want-to-write-all-of-my-code-inside-of-one-controller-class">
<h2>But I don&#8217;t want to write all of my code inside of one Controller class<a class="headerlink" href="#but-i-don-t-want-to-write-all-of-my-code-inside-of-one-controller-class" title="Permalink to this headline">¶</a></h2>
<p>Don&#8217;t worry. You don&#8217;t have to.</p>
<p>The only requirement is a single class which implements the service&#8217;s <cite>BaseServiceIface</cite>. Nothing specifies that <em>this</em> class needs to contain all of your service implementation or logic.</p>
<p>If you want to modularize or componentize to have a better separation of concerns in your code, your <cite>BaseServiceIface</cite> implementation can be easily written to inject other services or handlers such that complicated logic can be handled in other classes as is generally good practice. E.g.,</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>class ExampleThriftController @Inject() (
  add1Service: Add1Service,
  add2Service: Add2Service,
) extends Controller
  with ExampleService.BaseServiceIface {

      override val add1 = handle(Add1) { args: Add1.Args =&gt;
        add1Service.add1(args)
      }

      override val add2 = handle(Add2) { args: Add2.Args =&gt;
        add2Service.add2(args)
      }
    }
</pre></div>
</div>
<p>In the above example the <cite>BaseServiceIface</cite> implementation merely calls the methods of other classes to provide the service&#8217;s Thrift Controller method implementations.</p>
<p>How you structure and call other classes from the <cite>BaseServiceIface</cite> implementation is completely up to you to implement in whatever way makes sense for your service or team.</p>
</div>
<div class="section" id="more-information">
<h2>More information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<p>For more information, see the <a class="reference external" href="https://twitter.github.io/scrooge/Finagle.html">Finagle Integration</a> section of the <a class="reference external" href="https://twitter.github.io/scrooge/index.html">Scrooge</a> documentation.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  Finatra is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/">Site&nbsp;&amp;&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Github&nbsp;Repository</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Issues</a></li>
</ul>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Defining Thrift Controllers</a><ul>
<li><a class="reference internal" href="#handle-thriftmethod-dsl"><cite>handle(ThriftMethod)</cite> DSL</a></li>
<li><a class="reference internal" href="#ensure-you-override-using-val">Ensure you override using <cite>val</cite></a></li>
<li><a class="reference internal" href="#add-the-controller-to-the-server">Add the Controller to the Server</a></li>
<li><a class="reference internal" href="#but-i-don-t-want-to-write-all-of-my-code-inside-of-one-controller-class">But I don&#8217;t want to write all of my code inside of one Controller class</a></li>
<li><a class="reference internal" href="#more-information">More information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="server.html" title="previous chapter">Thrift Server Definition</a></li>
      <li>Next: <a href="filters.html" title="next chapter">Filtering Thrift Requests</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2017 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>