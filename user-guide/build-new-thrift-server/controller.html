<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Add a Thrift Controller - Finatra</title>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:800">
    <link rel="stylesheet" type="text/css" href="/finatra/javascripts/highlight/styles/idea.css">
    <script src="/finatra/javascripts/highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }

      .nav {
        font-size: 16px;
      }

      section.page {
        padding: 0px;
      }

      .parent-element {
        -webkit-transform-style: preserve-3d;
        -moz-transform-style: preserve-3d;
        transform-style: preserve-3d;
      }

      .element {
        position: relative;
        top: 50%;
        transform: translateY(-15%);
      }

      h1.brand {
        font-family: &#8216;Open Sans&#8217;, sans-serif;
        font-weight: 800;
        font-size: 84px !important;
      }

      .anchor { padding-top: 60px; }

      .no-pad-anchor .anchor { padding-top: 0px; }

      .embed-video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16/9 ratio */
        padding-top: 30px; /* IE6 workaround*/
        height: 0;
        overflow: hidden;
      }

      .embed-video-container iframe,
      .embed-video-container object,
      .embed-video-container embed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
    </style>
    <link rel="shortcut icon" href="/finatra/favicon.ico?v=2" type="image/x-icon">
    <link rel="icon" href="/finatra/favicon.ico?v=2" type="image/x-icon">
  </head>

  <body>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand element" href="/finatra"><img src="/finatra/images/finatra_transparent.gif" style="height:36px; width:36px"/></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="/finatra/blog/archives">Blog</a></li>
            <li><a href="/finatra/user-guide">User&nbsp;Guide&nbsp;<span class="glyphicon glyphicon-info-sign" title="More Information" aria-hidden="true"></span></a></li>
            <li><a href="/finatra/docs/index.html">Scaladoc</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="/finatra/presentations">Presentations&nbsp;&&nbsp;Slides</a></li>
            <li><a href="https://groups.google.com/forum/#!forum/finatra-users">Forum</a></li>
            <li><a href="/finatra/v1/docs/index.html" alt="Deprecated" title="Deprecated"><strike>v1.x Documentation&nbsp;</strike></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>

    <div class="container">
      <div id="main">
        <section class="page">

          <div>
<article role="article">
  <ol class="breadcrumb">
  <li><a href="/finatra/user-guide">User Guide</a></li>
  <li><a href="/finatra/user-guide/build-new-thrift-server">Building a New Thrift Server</a></li>
  <li class="active">Add a Controller</li>
</ol>


<h2>Thrift Controller Basics</h2>

<hr />

<p>A <em>Thrift Controller</em> is an implementation of your thrift service. To create the controller, extend the <code>com.twitter.finatra.thrift.Controller</code> trait and mix-in the <a href="http://twitter.github.io/scrooge/">Scrooge</a>-generated <code>BaseServiceIface</code> trait for your service. Scrooge generates a <code>ServiceIface</code> which is a case class containing a <code>Service</code> for each thrift method over the corresponding <code>Args</code> and <code>Result</code> structures for the method that extends from the <code>BaseServiceIface</code> trait. E.g,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">ServiceIface</span><span class="o">(</span>
</span><span class='line'>  <span class="n">fetchBlob</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">FetchBlob.Args</span>, <span class="kt">FetchBlob.Result</span><span class="o">]</span>
</span><span class='line'><span class="o">)</span> <span class="k">extends</span> <span class="nc">BaseServiceIface</span>
</span></code></pre></td></tr></table></div></figure>


<div></div>


<p>For Thrift Controllers we use the <code>BaseServiceIface</code> trait since we are not able to extend the <code>ServiceIface</code> case class.</p>

<p>The Finatra <code>com.twitter.finatra.thrift.Controller</code> provides a DSL with which you can easily implement your thrift service methods via a <code>handle(ThriftMethod)</code> function that takes a callback from <code>ThriftMethod.Args =&gt; Future[ThriftMethod.Result]</code>.</p>

<p>For example, given the following thrift IDL: <code>example_service.thrift</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">namespace</span> <span class="n">java</span> <span class="n">com</span><span class="o">.</span><span class="n">twitter</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">thriftjava</span>
</span><span class='line'><span class="o">#</span><span class="nd">@namespace</span> <span class="n">scala</span> <span class="n">com</span><span class="o">.</span><span class="n">twitter</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">thriftscala</span>
</span><span class='line'><span class="n">namespace</span> <span class="n">rb</span> <span class="nc">ExampleService</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="s">&quot;finatra-thrift/finatra_thrift_exceptions.thrift&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="nc">ExampleService</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">i32</span> <span class="n">add1</span><span class="o">(</span>
</span><span class='line'>    <span class="mi">1</span><span class="k">:</span> <span class="kt">i32</span> <span class="kt">num</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">throws</span> <span class="o">(</span>
</span><span class='line'>    <span class="mi">1</span><span class="k">:</span> <span class="kt">finatra_thrift_exceptions.ServerError</span> <span class="kt">serverError</span><span class="o">,</span>
</span><span class='line'>    <span class="mi">2</span><span class="k">:</span> <span class="kt">finatra_thrift_exceptions.UnknownClientIdError</span> <span class="kt">unknownClientIdError</span>
</span><span class='line'>    <span class="mi">3</span><span class="k">:</span> <span class="kt">finatra_thrift_exceptions.NoClientIdError</span> <span class="kt">noClientIdError</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<div></div>


<p>We can implement the following Thrift Controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">com.twitter.example.thriftscala.ExampleService</span>
</span><span class='line'><span class="k">import</span> <span class="nn">com.twitter.finatra.thrift.Controller</span>
</span><span class='line'><span class="k">import</span> <span class="nn">com.twitter.util.Future</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ExampleThriftController</span>
</span><span class='line'>  <span class="k">extends</span> <span class="nc">Controller</span>
</span><span class='line'>  <span class="k">with</span> <span class="nc">ExampleService</span><span class="o">.</span><span class="nc">BaseServiceIface</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">override</span> <span class="k">val</span> <span class="n">add1</span> <span class="k">=</span> <span class="n">handle</span><span class="o">(</span><span class="nc">Add1</span><span class="o">)</span> <span class="o">{</span> <span class="n">args</span><span class="k">:</span> <span class="kt">Add1.Args</span> <span class="o">=&gt;</span>
</span><span class='line'>    <span class="nc">Future</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<div></div>


<p>The <code>handle(ThriftMethod)</code> function may seem magical but it serves an important purpose. By implementing your service method via this function, it allows the framework to  apply the configured filter chain defined in your <a href="/finatra/user-guide/build-new-thrift-server#server-definition">server definition</a> to your method implementation (passed as the callback to <code>handle(ThriftMethod)</code>).</p>

<p>That is to say, the <code>handle(ThriftMethod)</code> function captures your method implementation then exposes it for the <a href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/routing/ThriftRouter.scala"><code>ThriftRouter</code></a> to combine with the configured filter chain to build the <a href="http://twitter.github.io/finagle/guide/ServicesAndFilters.html">Finagle Service</a> that represents your server. See the next <a href="/finatra/user-guide/build-new-thrift-server/filter.html">section</a> for more information on adding filters to your server definition.</p>

<p>Note, in the example above we implement the <code>ExampleService.BaseServiceIface#add1</code> method to satisfy the <code>ExampleService.BaseServiceIface</code> interface &ndash; however, the framework will not call the <code>add1</code> method in this way as it uses the implementation of the thrift method captured by the <code>handle(ThriftMethod)</code> function (as mentioned above this in order to apply the configured filter chain to requests). Thus if you were to directly call <code>ExampleThriftController.add1(request)</code> this would by-pass any configured <a href="/finatra/user-guide/build-new-thrift-server/filter.html">filters</a> from the server definition.</p>

<p>We use <code>override val</code> since the computed <a href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/internal/ThriftMethodService.scala"><code>ThriftMethodService</code></a> instance returned <a href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/Controller.scala#L19">is effectively constant</a>.</p>

<p>As previously shown, the server can then be defined with this Thrift Controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">ExampleServer</span> <span class="k">extends</span> <span class="nc">ThriftServer</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">configureThrift</span><span class="o">(</span><span class="n">router</span><span class="k">:</span> <span class="kt">ThriftRouter</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">router</span>
</span><span class='line'>      <span class="o">.</span><span class="n">add</span><span class="o">[</span><span class="kt">ExampleThriftController</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<div></div>


<p>Please note that Finatra only currently supports adding a <strong>single</strong> Thrift controller to the <code>ThriftRouter</code>. The expectation is that you are implementing a single Thrift <em>service</em> and thus a single <code>BaseServiceIface</code> which is implementable in a single controller. If you want to break down your code, you can always marshal calls from the single controller to any number of other classes. In this way, the controller would just be a thin wrapper which proxies to other classes.</p>

<h2><a class="anchor" name="more-information" href="#more-information">More information</a></h2>

<hr />

<p>For more information, see the <a href="http://twitter.github.io/scrooge/Finagle.html">Finagle Integration</a> section of the <a href="http://twitter.github.io/scrooge/index.html">Scrooge</a> documentation.</p>

<p>Next section: <a href="/finatra/user-guide/build-new-thrift-server/filter.html">Add Filters</a>.</p>

<p><nav>
  <ul class="pager">
    <li class="previous"><a href="/finatra/user-guide/build-new-thrift-server"><span aria-hidden="true">&larr;</span>&nbsp;Building&nbsp;a&nbsp;New&nbsp;Thrift&nbsp;Server</a></li>
    <li class="next"><a href="/finatra/user-guide/build-new-thrift-server/filter.html">Add&nbsp;Filters&nbsp;<span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav></p>

  
    <footer>
      
      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>



        </section>
      </div>
    </div>


    <div id="footer">
      <div class="container">
        <div class="row">&nbsp;</div>
        <div class="row">&nbsp;</div>
        <div class="row">
          <div class="col-md-10">
            <p>
              Copyright &copy; 2013-2016&nbsp;Twitter - <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
            </p></div>
          <div class="col-md-2">
            <p class="text-muted credit text-right"><a href="https://twitter.com/finatra" data-size="large" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @finatra</a>
              <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>
          </div>
        </div>
      </div>
    </div>


    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39101739-9', 'twitter.github.io/finatra');
      ga('send', 'pageview');
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  </body>
</html>
