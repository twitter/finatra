
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Flags &#8212; Finatra 22.3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Future Gotchas" href="futures.html" />
    <link rel="prev" title="Binding Annotations" href="binding_annotations.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="futures.html" title="Future Gotchas"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="binding_annotations.html" title="Binding Annotations"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="flags">
<span id="id1"></span><h1>Flags<a class="headerlink" href="#flags" title="Permalink to this headline">¶</a></h1>
<p>Finatra builds on the support of <a class="reference external" href="https://github.com/twitter/util">TwitterUtil</a> <a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flag.scala">Flags</a>
from <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#flags">TwitterServer</a>, adding the
ability to inject parsed Flag values into your classes.</p>
<p>Flags by their definition represent some external configuration that is passed to the server and are
thus an excellent way to parameterize configuration that may be environment specific, e.g., a
database host or URL that is different per environment: <em>production</em>, <em>staging</em>, <em>development</em>, or
<em>jills-staging</em>. Having a strict separation of configuration from code allows for deploying the
exact same application code across different execution environments which maximizes the portability
of your code.</p>
<p>This type of configuration parameterization is generally preferred over hardcoding logic by a type
of “<em>environment</em>” string within code, e.g.</p>
<div class="code bash highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">env</span> <span class="o">==</span> <span class="s">&quot;production&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</pre></div>
</div>
<p>It is generally good practice to make Flags <em>granular</em> controls that are fully orthogonal to one
another. They can then be independently managed for each deploy and this scales consistently as the
number of supported  “environments” scales.</p>
<div class="admonition-best-practices admonition">
<p class="first admonition-title">Best Practices</p>
<p class="last">See the <a class="reference external" href="#id4">Best Practices</a> section for general guidelines on working with Flags in Finatra.</p>
</div>
<div class="section" id="global-flags">
<h2>Global Flags<a class="headerlink" href="#global-flags" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/twitter/util">TwitterUtil</a> <a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flag.scala">Flags</a>
also has the concept of a “global” flag. That is, a flag that is “global” to the JVM process (as it is
generally defined as a Scala object). In the discussion of Flags with Finatra we <strong>do not</strong> mean
“global” flags unless it is explicitly stated.</p>
<p>See the <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/GlobalFlag.html">scaladoc</a> for
<cite>c.t.app.GlobalFlag</cite> for more information.</p>
</div>
<div class="section" id="but-i-have-a-lot-of-flags">
<h2>But I have a lot of Flags<a class="headerlink" href="#but-i-have-a-lot-of-flags" title="Permalink to this headline">¶</a></h2>
<p>If you find that you end up with a lot of Flags to configure for your service and your deployment
system provides no relief – there are still alternatives to moving external configuration into code.</p>
<p>See <a class="reference external" href="https://groups.google.com/forum/#!searchin/finatra-users/typesafe$20config%7Csort:relevance/finatra-users/kkZgI5dG9CY/lzDPAmUxAwAJ">this thread</a>
on using <a class="reference external" href="https://github.com/lightbend/config">Lightbend Config</a> with Finatra.</p>
</div>
<div class="section" id="when-are-flags-parsed">
<h2>When Are Flags Parsed?<a class="headerlink" href="#when-are-flags-parsed" title="Permalink to this headline">¶</a></h2>
<p>It is important to understand <em>when</em> in the application lifecycle Flag values are parsed from command
line input into an instance of the the Flag’s defined <a class="reference external" href="https://github.com/twitter/util/blob/ed6f6a73a41d1b7e8331687567e3191cd5ead19e/util-app/src/main/scala/com/twitter/app/Flag.scala#L55">Flaggable[T]</a> type <cite>T</cite>.</p>
<div class="admonition-overview admonition">
<p class="first admonition-title">Overview</p>
<p class="last">Flag values are parsed from command line input <em>after</em> the <cite>c.t.app.App#init</cite> application lifecycle
phase and <em>before</em> the <cite>c.t.app.App#premain</cite> lifecycle phase.</p>
</div>
<p>Flags are not parsed during class loading or initialization, rather, Flag parsing happens
<em>in-between</em> the running of all registered <cite>init()</cite> functions and the running of all registered
<cite>premain</cite> functions. Thus care should be taken when attempting to access a Flag value to ensure it
is not done until at least the <strong>premain</strong> application lifecycle phase.</p>
<p>For more information on the application lifecycle see the documentation <a class="reference external" href="lifecycle.html">here</a>.</p>
<div class="section" id="c-t-app-app-failfastonflagsnotparsed">
<h3><cite>c.t.app.App#failfastOnFlagsNotParsed</cite><a class="headerlink" href="#c-t-app-app-failfastonflagsnotparsed" title="Permalink to this headline">¶</a></h3>
<p>Note that Finatra defaults the <a class="reference external" href="https://github.com/twitter/util/blob/5e326a1109e2cd608515ce87badfb792bd346a3d/util-app/src/main/scala/com/twitter/app/App.scala#L57">c.t.app.App#failfastOnFlagsNotParsed</a>
option as mentioned in the <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#flags">TwitterServer documentation</a> to
<strong>‘true’</strong>. This is done in the Finatra extension <a class="reference external" href="https://github.com/twitter/finatra/blob/c1b49edebb0ad513f2b3439ee4f2f5e0541e2b26/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala#L127">c.t.inject.app.App</a>
which overrides the superclass implementation with <strong>‘true’</strong>.</p>
<p>Having this option turned on means that if a Flag value is accessed before the Flag has been parsed
then an <cite>IllegalStateException</cite> will be thrown. This “fail fast” behavior is preferable over silently
reading a default value by mistake and not a parsed value from the command line.</p>
<div class="section" id="modules">
<h4>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h4>
<p>Flags created within a Finatra <cite>TwitterModule</cite> are collected and added to the application’s
<a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/Flags.scala">c.t.app.Flags</a>
collection during the <cite>init</cite> lifecycle phase. Thus, they will not inherit the application’s setting
for “fail fast” until then.</p>
<p>The default for the “fail fast” behavior of Flags created within a Finatra <cite>TwitterModule</cite> is governed
by the value set for <cite>c.t.inject.TwitterModuleFlags#failfastOnFlagsNotParsed</cite> in the <cite>TwitterModule</cite>
which is also defaulted to <strong>‘true’</strong> to mirror the application container default.</p>
<p>This means that like a Flag created with the application, any attempt to access a <cite>TwitterModule</cite>
created Flag’s value too eagerly will also result in an <cite>IllegalStateException</cite> being thrown.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>We highly recommend that all applications keep <a class="reference external" href="https://github.com/twitter/finatra/blob/c1b49edebb0ad513f2b3439ee4f2f5e0541e2b26/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala#L127">c.t.inject.app.App#failfastOnFlagsNotParsed</a>
and <a class="reference external" href="https://github.com/twitter/finatra/blob/8435309bd5d729537db4960e4f09d55b537fc75b/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleFlags.scala#L29">c.t.inject.TwitterModuleFlags#failfastOnFlagsNotParsed</a>
not only set to the <strong>same value</strong> but also <strong>kept to their default of ‘true’</strong>.</p>
<p class="last">This should arguably be the default behavior for Flag instances but for legacy reasons is not.</p>
</div>
</div>
<div class="section" id="flags-with-no-command-line-value">
<h4>Flags With No Command Line Value<a class="headerlink" href="#flags-with-no-command-line-value" title="Permalink to this headline">¶</a></h4>
<p>If no command line input is given for a defined Flag, accessing the Flag value should still not
occur until after parsing of command line input has been attempted. The <a class="reference external" href="https://github.com/twitter/util/blob/ed6f6a73a41d1b7e8331687567e3191cd5ead19e/util-app/src/main/scala/com/twitter/app/Flags.scala#L89">c.t.app.Flags</a>
instance within your application is stateful and is only fully initialized <em>after parsing</em> of any
command line input and thus Flags should not be considered “ready” for accessing until this step
has completed.</p>
<p>If the Flag defines a default, the <a class="reference external" href="https://github.com/twitter/util/blob/ed6f6a73a41d1b7e8331687567e3191cd5ead19e/util-app/src/main/scala/com/twitter/app/Flag.scala#L186">default value</a> will be returned when no command line value is
given. If the Flag is defined without a default and no command line value is given, any attempt to
read the Flag’s value via the <cite>apply()</cite> function will fail with an <cite>IllegalArgumentException</cite>.</p>
<p>It is, however, possible to inject Flags without default values as options (both <cite>scala.Option</cite> and
<cite>java.util.Optional</cite>). For more information on defining and accessing Flags without default values,
see <a class="reference external" href="#flags-without-defaults">here</a>.</p>
</div>
</div>
</div>
<div class="section" id="how-to-define-flags">
<h2>How To Define Flags<a class="headerlink" href="#how-to-define-flags" title="Permalink to this headline">¶</a></h2>
<p>Flags should be defined as part of instance creation/instantiation (i.e., via the constructor) in
either a <cite>c.t.inject.TwitterModule</cite> or an application (any extension of <cite>c.t.app.App</cite>) and thus
declared before command line input has been parsed.</p>
<div class="section" id="within-an-app-or-a-server">
<h3>Within an App or a Server<a class="headerlink" href="#within-an-app-or-a-server" title="Permalink to this headline">¶</a></h3>
<p>While Flags are most typically <a class="reference external" href="https://github.com/twitter/finatra/blob/ec8d584eb914f50f92314c740dc68fb7abb47eff/http/src/test/scala/com/twitter/finatra/http/tests/integration/doeverything/main/modules/DoEverythingModule.scala#L13">defined</a>
within a <a class="reference external" href="modules.html">TwitterModule</a> to allow for scoping of reusable external configuration
(since Modules are meant to be re-usable), you can also choose to define a Flag
<a class="reference external" href="https://github.com/twitter/finatra/blob/ec8d584eb914f50f92314c740dc68fb7abb47eff/http/src/test/scala/com/twitter/finatra/http/tests/integration/doeverything/main/DoEverythingServer.scala#L22">directly in an or a server</a>.</p>
<p>In this case within an <a class="reference external" href="../http/server.html">HttpServer</a>,</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">DoEverythingModule</span>
<span class="k">import</span> <span class="nn">ExampleController</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.</span><span class="o">{</span><span class="nc">Contoller</span><span class="o">,</span> <span class="nc">HttpServer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.filters.</span><span class="o">{</span><span class="nc">CommonFilters</span><span class="o">,</span> <span class="nc">LoggingMDCFilter</span><span class="o">,</span> <span class="nc">TraceIdMDCFilter</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.routing.HttpRouter</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="k">class</span> <span class="nc">ExampleController</span> <span class="nd">@Inject</span><span class="o">()(</span>
  <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;magic.num&quot;</span><span class="o">)</span> <span class="n">magicNum</span><span class="k">:</span> <span class="kt">Int</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/foo&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span><span class="k">:</span> <span class="kt">Request</span> <span class="o">=&gt;</span>
      <span class="n">magicNum</span><span class="o">.</span><span class="n">toString</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">ExampleServerMain</span> <span class="k">extends</span> <span class="nc">ExampleServer</span>

<span class="k">class</span> <span class="nc">ExampleServer</span> <span class="k">extends</span> <span class="nc">HttpServer</span> <span class="o">{</span>

  <span class="n">flag</span><span class="o">(</span><span class="s">&quot;magic.num&quot;</span><span class="o">,</span> <span class="mi">42</span><span class="o">,</span> <span class="s">&quot;Defines a magic number flag.&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">modules</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="nc">DoEverythingModule</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">configureHttp</span><span class="o">(</span><span class="n">router</span><span class="k">:</span> <span class="kt">HttpRouter</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
    <span class="n">router</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">[</span><span class="kt">LoggingMDCFilter</span><span class="o">[</span><span class="kt">Request</span>, <span class="kt">Response</span><span class="o">]]</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">[</span><span class="kt">TraceIdMDCFilter</span><span class="o">[</span><span class="kt">Request</span>, <span class="kt">Response</span><span class="o">]]</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">[</span><span class="kt">CommonFilters</span><span class="o">]</span>
      <span class="o">.</span><span class="n">add</span><span class="o">[</span><span class="kt">ExampleController</span><span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>or in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">DoEverythingModule</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">ExampleController</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Module</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finagle.http.Request</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.AbstractController</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.AbstractHttpServer</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.filters.CommonFilters</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.filters.LoggingMDCFilter</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.filters.TraceIdMDCFilter</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.routing.HttpRouter</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">scala.reflect.ManifestFactory</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">ExampleController</span> <span class="k">extends</span> <span class="nc">AbstractController</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">final</span> <span class="nc">Integer</span> <span class="n">magicNum</span><span class="o">;</span>

  <span class="nd">@Inject</span>
  <span class="n">public</span> <span class="nc">ExampleController</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;magic.num&quot;</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">magicNum</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">magicNum</span> <span class="k">=</span> <span class="n">magicNum</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="n">void</span> <span class="n">configureRoutes</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/foo&quot;</span><span class="o">,</span> <span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">magicNum</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">ExampleServerMain</span> <span class="o">{</span>
  <span class="k">private</span> <span class="nc">ExampleServerMain</span><span class="o">()</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ExampleServer</span><span class="o">().</span><span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">ExampleServer</span> <span class="k">extends</span> <span class="nc">AbstractHttpServer</span> <span class="o">{</span>

  <span class="n">public</span> <span class="nc">ExampleServer</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">createFlag</span><span class="o">(</span>
      <span class="cm">/* name      = */</span> <span class="s">&quot;magic.num&quot;</span><span class="o">,</span>
      <span class="cm">/* default   = */</span> <span class="mi">42</span><span class="o">,</span>
      <span class="cm">/* help      = */</span> <span class="s">&quot;Defines a magic number flag.&quot;</span><span class="o">,</span>
      <span class="cm">/* flaggable = */</span> <span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofJavaInteger</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Module</span><span class="o">&gt;</span> <span class="n">javaModules</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="n">singletonList</span><span class="o">((</span>
        <span class="k">new</span> <span class="nc">DoEverythingModule</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">configureHttp</span><span class="o">(</span><span class="nc">HttpRouter</span> <span class="n">router</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">router</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="nc">ManifestFactory</span><span class="o">.</span><span class="n">classType</span><span class="o">(</span><span class="nc">LoggingMDCFilter</span><span class="o">.</span><span class="n">class</span><span class="o">))</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="nc">ManifestFactory</span><span class="o">.</span><span class="n">classType</span><span class="o">(</span><span class="nc">TraceIdFilter</span><span class="o">.</span><span class="n">class</span><span class="o">))</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="nc">CommonFilters</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">ExampleController</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The parsed value of the Flag, <cite>magic.num</cite> would be available to be injected where necessary using
the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> binding annotation.</p>
<p>Or it can be obtained directly from the Injector:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">DoEverythingModule</span>
<span class="k">import</span> <span class="nn">ExampleController</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.HttpServer</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.filters.</span><span class="o">{</span><span class="nc">CommonFilters</span><span class="o">,</span> <span class="nc">LoggingMDCFilter</span><span class="o">,</span> <span class="nc">TraceIdMDCFilter</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.twitter.finatra.http.routing.HttpRouter</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flags</span>
<span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="c1">// Note: we define our Controller without the `@Inject()` annotation on the construction,</span>
<span class="c1">// thus args need to always be passed in since the injector will not be able to instantiate.</span>
<span class="c1">// Also note: this is just an example.</span>
<span class="k">class</span> <span class="nc">ExampleController</span><span class="o">(</span><span class="n">magicNum</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/foo&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span><span class="k">:</span> <span class="kt">Request</span> <span class="o">=&gt;</span>
      <span class="o">???</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">ExampleServerMain</span> <span class="k">extends</span> <span class="nc">ExampleServer</span>

<span class="k">class</span> <span class="nc">ExampleServer</span> <span class="k">extends</span> <span class="nc">HttpServer</span> <span class="o">{</span>

  <span class="n">flag</span><span class="o">(</span><span class="s">&quot;magic.num&quot;</span><span class="o">,</span> <span class="mi">42</span><span class="o">,</span> <span class="s">&quot;Defines a magic number flag.&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">modules</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="nc">DoEverythingModule</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">configureHttp</span><span class="o">(</span><span class="n">router</span><span class="k">:</span> <span class="kt">HttpRouter</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
    <span class="n">router</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">[</span><span class="kt">LoggingMDCFilter</span><span class="o">[</span><span class="kt">Request</span>, <span class="kt">Response</span><span class="o">]]</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">[</span><span class="kt">TraceIdMDCFilter</span><span class="o">[</span><span class="kt">Request</span>, <span class="kt">Response</span><span class="o">]]</span>
      <span class="o">.</span><span class="n">filter</span><span class="o">[</span><span class="kt">CommonFilters</span><span class="o">]</span>
      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleController</span><span class="o">(</span><span class="n">injector</span><span class="o">.</span><span class="n">instance</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="nc">Flags</span><span class="o">.</span><span class="n">named</span><span class="o">(</span><span class="s">&quot;magic.num&quot;</span><span class="o">))))</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="within-a-twittermodule">
<h3>Within a <a class="reference external" href="modules.html">TwitterModule</a><a class="headerlink" href="#within-a-twittermodule" title="Permalink to this headline">¶</a></h3>
<p>When defined within a <a class="reference external" href="modules.html">TwitterModule</a>, Flags can be used to aid in the construction
of an instance to be <a class="reference external" href="modules.html#provides">provided to the object graph</a>, e.g., a <cite>DatabaseConnection</cite>
instance with the database URL specified by a Flag. The module is then able to tell the Injector how
to provide an instance of this type when necessary by defining an <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code> annotated method.
More information on defining Modules can be found <a class="reference external" href="modules.html">here</a>.</p>
<p>In Finatra, we also provide a way to override bound instances in the object graph when testing
through <a class="reference external" href="../testing/index.html#override-modules">Override Modules</a> or by using
<a class="reference external" href="../testing/index.html##embedded-server-bind-t">Embedded Server #bind[T]</a>.</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.google.inject.Provides</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">class</span> <span class="nc">MyModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="n">flag</span><span class="o">(</span><span class="n">name</span> <span class="k">=</span> <span class="s">&quot;key&quot;</span><span class="o">,</span> <span class="n">default</span> <span class="k">=</span> <span class="s">&quot;default&quot;</span><span class="o">,</span> <span class="n">help</span> <span class="k">=</span> <span class="s">&quot;The key to use&quot;</span><span class="o">)</span>

  <span class="nd">@Provides</span>
  <span class="nd">@Singleton</span>
  <span class="k">def</span> <span class="n">provideFoo</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Foo</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">Foo</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>and in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.google.inject.Provides</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">MyModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="n">public</span> <span class="nc">MyModule</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">createFlag</span><span class="o">(</span>
      <span class="cm">/* name      = */</span> <span class="s">&quot;key&quot;</span><span class="o">,</span>
      <span class="cm">/* default   = */</span> <span class="s">&quot;default&quot;</span><span class="o">,</span>
      <span class="cm">/* help      = */</span> <span class="s">&quot;The key to use&quot;</span><span class="o">,</span>
      <span class="cm">/* flaggable = */</span> <span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofString</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Provides</span>
  <span class="nd">@Singleton</span>
  <span class="n">public</span> <span class="nc">Foo</span> <span class="n">provideFoo</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Foo</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In the examples above, notice that we <strong>do not save a local reference to the created Flag</strong> but instead
reference its value by use of the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> binding annotation or by obtaining the parsed value
directly from the Injector.</p>
<div class="section" id="flag-annotation">
<h4><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code> annotation<a class="headerlink" href="#flag-annotation" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> is a <a class="reference external" href="../getting-started/binding_annotations.html">binding annotation</a>. This annotation
allows parsed Flag values to be injected into classes (and provider methods).</p>
</div>
<div class="section" id="understanding-flag-binding">
<h4>Understanding Flag Binding<a class="headerlink" href="#understanding-flag-binding" title="Permalink to this headline">¶</a></h4>
<p>The key component of Flag binding is <a class="reference external" href="https://github.com/twitter/util/blob/1bdeab56e49015c1f4c097ef76e47b93a079a239/util-app/src/main/scala/com/twitter/app/Flaggable.scala#L19"><code class="docutils literal notranslate"><span class="pre">Flaggable[T]</span></code></a>, a type-class that defines how a Flag of
type <cite>T</cite> can be parsed from a given string. In Finatra, you can bind / inject any Flag value as
long as there is a <cite>Flaggable.Typed[T]</cite> instance available for it. Otherwise, you’d need to either
manually register a flag converter (if you don’t control / can’t change the Flaggable) within a
framework middleware or make sure a Flaggable is implemented as <cite>Flaggable.Typed[T]</cite>.</p>
<p>Making a Flaggable <cite>Flaggable.Typed[T]</cite></p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.app.Flaggable</span>
<span class="k">import</span> <span class="nn">java.lang.reflect.Type</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Foo</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">object</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="n">flaggable</span><span class="k">:</span> <span class="kt">Flaggable</span><span class="o">[</span><span class="kt">Foo</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flaggable</span><span class="o">.</span><span class="n">mandatory</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Foo</span><span class="o">(</span><span class="n">s</span><span class="o">))</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Registering a Flag converter</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>

<span class="k">class</span> <span class="nc">MyModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
   <span class="k">def</span> <span class="n">configure</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
     <span class="n">addFlagConverter</span><span class="o">[</span><span class="kt">List</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">)]]</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.TypeLiteral</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.matcher.Matchers</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.app.Flaggable</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">MyModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">addFlagConverter</span><span class="o">(</span>
      <span class="nc">Matchers</span><span class="o">.</span><span class="n">only</span><span class="o">(</span><span class="k">new</span> <span class="nc">TypeLiteral</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="n">scala</span><span class="o">.</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;&gt;()</span> <span class="o">{}),</span>
      <span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofJavaList</span><span class="o">(</span><span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofTuple</span><span class="o">(</span><span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofJavaInteger</span><span class="o">,</span> <span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofJavaInteger</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="holding-a-reference">
<h4>Holding a Reference<a class="headerlink" href="#holding-a-reference" title="Permalink to this headline">¶</a></h4>
<p>When defining a Flag you can also dereference the Flag value directly within the Module or server
(in lieu of using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> annotation). However, you should be <strong>extremely cautious</strong> when doing
so.</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.google.inject.Provides</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.foo.bar.ThirdPartyFoo</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">MyModule1</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">key</span> <span class="k">=</span> <span class="n">flag</span><span class="o">(</span><span class="n">name</span> <span class="k">=</span> <span class="s">&quot;key&quot;</span><span class="o">,</span> <span class="n">default</span> <span class="k">=</span> <span class="s">&quot;default&quot;</span><span class="o">,</span> <span class="n">help</span> <span class="k">=</span> <span class="s">&quot;The key to use&quot;</span><span class="o">)</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideThirdPartyFoo</span><span class="k">:</span> <span class="kt">ThirdPartyFoo</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ThirdPartyFoo</span><span class="o">(</span><span class="n">key</span><span class="o">())</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is potentially dangerous. See the next sections for details.</p>
</div>
<div class="section" id="caution">
<h5>Caution<a class="headerlink" href="#caution" title="Permalink to this headline">¶</a></h5>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Flags are distinct by name only.</p>
</div>
<p>Note that holding onto a reference of a Flag can be potentially dangerous since Flag definitions
can be overridden with another definition. Flags are distinct <a class="reference external" href="https://github.com/twitter/util/blob/ed6f6a73a41d1b7e8331687567e3191cd5ead19e/util-app/src/main/scala/com/twitter/app/Flags.scala#L251">by name only</a>.
The Flag you are referencing can be replaced in the stateful <a class="reference external" href="https://github.com/twitter/util/blob/ed6f6a73a41d1b7e8331687567e3191cd5ead19e/util-app/src/main/scala/com/twitter/app/Flags.scala#L89">c.t.app.Flags</a>
instance of your application with another instance created with the same name. The last Flag added
wins and thus when the Flags are parsed your reference may not be updated with the parsed value,
resulting in the reference retaining its default value or no value if it has no specified default.</p>
<p>You should only do this if you are guaranteed that the Flag defined for which you keep a
reference will not be redefined making your reference obsolete.</p>
</div>
<div class="section" id="even-more-caution">
<h5>Even More Caution<a class="headerlink" href="#even-more-caution" title="Permalink to this headline">¶</a></h5>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Eagerly evaluating a Flag value before the Flag has been parsed will not always fail.</p>
</div>
<p>Additionally, having a reference can lead to unintentionally trying to dereference the Flag value
before the command-line value has been parsed. If the Flag has a reasonable default, your code
may even appear to work until the passed command-line value is changed, which will have no effect on
the Flag because the Flag is being evaluated too early in the <a class="reference external" href="./lifecycle.html#c-t-inject-app-app-lifecycle">Application Lifecycle</a>.</p>
<p>The recommendation is to not hold a reference to a created Flag and instead obtain the parsed Flag
value via injection. See the <a class="reference external" href="#flag-value-injection">Flag Value Injection</a> section for details.</p>
</div>
<div class="section" id="ok-but-i-want-to-live-dangerously">
<h5>Ok, But I Want To Live Dangerously<a class="headerlink" href="#ok-but-i-want-to-live-dangerously" title="Permalink to this headline">¶</a></h5>
<p>If you find you must keep a local reference to the created Flag, then you can use the <a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flag.scala#L171">Flag#apply</a>,
<a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flag.scala#L205">Flag#get</a>
or other methods, depending, to obtain the parsed Flag value. Again, this is not recommended and
caution should be exercised when using Flags in this manner to respect the application lifecycle
with regards to <a class="reference external" href="#when-are-flags-parsed">when Flags are parsed</a>.</p>
</div>
</div>
<div class="section" id="id3">
<h4>Flag Value Injection<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The parsed value of a Flag can be injected as a constructor-arg to a class using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a>
<a class="reference external" href="./binding_annotations.html">binding annotation</a>. When the class is obtained from the Injector,
the correctly parsed Flag value will be injected.</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="k">class</span> <span class="nc">MyService</span> <span class="nd">@Inject</span><span class="o">()(</span>
  <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note, you can also always instantiate the above class manually. When doing so, you will need to pass
all the constructor args manually including a value for the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> annotated argument.</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">svc</span><span class="k">:</span> <span class="kt">MyService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">key</span> <span class="k">=</span> <span class="s">&quot;foo&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>You can also ask the Injector directly for a Flag value using <cite>Flags.named</cite> (similar to Guice’s
<a class="reference external" href="https://github.com/google/guice/blob/master/core/src/com/google/inject/name/Names.java"><cite>Names.named</cite></a>):</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.inject.Injector</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flags</span>

<span class="k">val</span> <span class="n">key</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="n">instance</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Flags</span><span class="o">.</span><span class="n">named</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">))</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Attempting to get a Flag value from the Injector for a Flag <strong>without</strong> a default
nor a user-specified value will result in a <cite>ProvisionException</cite>.</p>
</div>
</div>
<div class="section" id="flag-value-injection-benefits">
<h4>Flag Value Injection Benefits<a class="headerlink" href="#flag-value-injection-benefits" title="Permalink to this headline">¶</a></h4>
<p>A side-effect of not holding onto Flag references in a <cite>TwitterModule</cite> is that it increases the possibility
of using the <cite>&#64;Provides</cite>-annotated method in a non-injection context. Everything needed to construct
the returned type can be defined as an argument to the method, essentially making the <cite>&#64;Provides</cite>-annotated
method a type of <a class="reference external" href="https://en.wikipedia.org/wiki/Factory_method_pattern">Factory method</a>.</p>
<p>When the <cite>&#64;Provides</cite>-annotated method directly applies a held Flag reference it means the method
is tied to the lifecycle of the Flag reference. The method cannot be properly called until the Flag
reference has been parsed.</p>
<p>Removing usage of a held Flag reference and instead allowing the Flag value to be <a class="reference external" href="#id3">injected</a>
(like <a class="reference external" href="modules.html#provides">any other needed dependency</a>) means the method can be used
independently of the Flag lifecycle or even injection.</p>
<p>For example, if we had a class <cite>Notifier</cite>:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.util.Duration</span>

<span class="k">class</span> <span class="nc">Notifier</span><span class="o">(</span>
  <span class="n">connection</span><span class="k">:</span> <span class="kt">DatabaseConnection</span><span class="o">,</span>
  <span class="n">emailer</span><span class="k">:</span> <span class="kt">Emailer</span> <span class="o">,</span>
  <span class="n">serializer</span><span class="k">:</span> <span class="kt">Serializer</span><span class="o">,</span>
  <span class="n">notificationFrequency</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span>
</pre></div>
</div>
<p>and a module, <cite>NotifierModule</cite>:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.google.inject.Provides</span>
<span class="k">import</span> <span class="nn">com.twitter.conversions.DurationOps._</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">com.twitter.util.Duration</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">NotifierModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="n">flag</span><span class="o">(</span><span class="n">name</span> <span class="k">=</span> <span class="s">&quot;frequency.interval.minutes&quot;</span><span class="o">,</span> <span class="n">default</span> <span class="k">=</span> <span class="mf">60.</span><span class="n">minutes</span><span class="o">,</span> <span class="n">help</span> <span class="k">=</span> <span class="s">&quot;Interval for notifications&quot;</span><span class="o">)</span>

  <span class="nd">@Provides</span>
  <span class="nd">@Singleton</span>
  <span class="k">def</span> <span class="n">provideNotifier</span><span class="o">(</span>
    <span class="n">connection</span><span class="k">:</span> <span class="kt">DatabaseConnection</span><span class="o">,</span>
    <span class="n">emailer</span><span class="k">:</span> <span class="kt">Emailer</span> <span class="o">,</span>
    <span class="n">serializer</span><span class="k">:</span> <span class="kt">Serializer</span><span class="o">,</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;frequency.interval.minutes&quot;</span><span class="o">)</span> <span class="n">interval</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Notifier</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">Notifier</span><span class="o">(</span>
      <span class="n">connection</span><span class="o">,</span>
      <span class="n">emailer</span><span class="o">,</span>
      <span class="n">serializer</span><span class="o">,</span>
      <span class="n">interval</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You could use this Module in non-injection context – like providing a test fixture, since you have
static utility to construct a <cite>Notifier</cite> over its necessary parts. That is, you could do something
along the lines of:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.conversions.DurationOps._</span>

<span class="k">val</span> <span class="n">mockDatabaseConnection</span><span class="k">:</span> <span class="kt">DatabaseConnection</span> <span class="o">=</span> <span class="n">mock</span><span class="o">[</span><span class="kt">DatabaseConnection</span><span class="o">]</span>
<span class="k">val</span> <span class="n">mockEmailer</span><span class="k">:</span> <span class="kt">Emailer</span> <span class="o">=</span> <span class="n">mock</span><span class="o">[</span><span class="kt">Emailer</span><span class="o">]</span>
<span class="k">val</span> <span class="n">mockSerializer</span><span class="k">:</span> <span class="kt">Serializer</span> <span class="o">=</span> <span class="n">mock</span><span class="o">[</span><span class="kt">Serializer</span><span class="o">]</span>

<span class="k">val</span> <span class="n">notifierStub</span><span class="k">:</span> <span class="kt">Notifier</span> <span class="o">=</span>
  <span class="nc">NotifierModule</span><span class="o">.</span><span class="n">provideNotifier</span><span class="o">(</span>
    <span class="n">connection</span> <span class="k">=</span> <span class="n">mockDatabaseConnection</span><span class="o">,</span>
    <span class="n">emailer</span> <span class="k">=</span> <span class="n">mockEmailer</span>
    <span class="n">serializer</span> <span class="k">=</span> <span class="n">mockSerializer</span>
    <span class="n">notificationFrequency</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span>
</pre></div>
</div>
<p>See the <a class="reference external" href="https://jasonpolites.github.io/tao-of-testing/ch3-1.1.html">The Tao of Testing: Chapter 3 - Dependency Injection</a>
for more information and examples of Dependency Injection approaches to writing testable code.</p>
</div>
</div>
</div>
<div class="section" id="flags-without-defaults">
<h2>Flags Without Defaults<a class="headerlink" href="#flags-without-defaults" title="Permalink to this headline">¶</a></h2>
<p>Flags without a default nor a user-supplied value will fail injection (since de-referencing the value
in this case results in an <cite>IllegalArgumentException</cite>), unless they are injected
as <a class="reference external" href="#injecting-optional-flags">optional flags</a>. This means if you try to inject the value of a
non-defaulted Flag that has not been supplied a value from the command-line using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a>
binding annotation, a <cite>ProvisionException</cite> will be thrown caused by the <cite>IllegalArgumentException</cite> <a class="reference external" href="https://github.com/twitter/finatra/blob/ec8d584eb914f50f92314c740dc68fb7abb47eff/inject/inject-app/src/main/scala/com/twitter/inject/app/internal/FlagsModule.scala">here</a>.</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.foo.bar.ThirdPartyFoo</span>
<span class="k">import</span> <span class="nn">com.google.inject.Provides</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">MyModule1</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="n">flag</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">name</span> <span class="k">=</span> <span class="s">&quot;key&quot;</span><span class="o">,</span> <span class="n">help</span> <span class="k">=</span> <span class="s">&quot;The key to use&quot;</span><span class="o">)</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideThirdPartyFoo</span><span class="o">(</span><span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="n">myKey</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ThirdPartyFoo</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">ThirdPartyFoo</span><span class="o">(</span><span class="n">myKey</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>and in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.foo.bar.ThirdPartyFoo</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Provides</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span><span class="o">;</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">MyModule1</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="n">public</span> <span class="nc">MyModule1</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">createMandatoryFlag</span><span class="o">(</span>
      <span class="cm">/* name      = */</span> <span class="s">&quot;key&quot;</span><span class="o">,</span>
      <span class="cm">/* help      = */</span> <span class="s">&quot;The key to use&quot;</span><span class="o">,</span>
      <span class="cm">/* usage     = */</span> <span class="s">&quot;Pass -key=value&quot;</span><span class="o">,</span>
      <span class="cm">/* flaggable = */</span> <span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofString</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="n">public</span> <span class="nc">ThirdPartyFoo</span> <span class="n">provideThirdPartyFoo</span><span class="o">(</span><span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="nc">String</span> <span class="n">myKey</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">ThirdPartyFoo</span><span class="o">(</span><span class="n">myKey</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In this example, we are assured that we will have the parsed Flag value obtained from the Injector
in our <cite>&#64;Provides</cite>-annotated method. If there is no supplied command-line value this will fail
(as mentioned previously) at server startup with a <cite>ProvisionException</cite>. Thus, this ensures that
we cannot start the server without a command-line value being supplied.</p>
<div class="section" id="injecting-optional-flags">
<h3>Injecting Optional Flags<a class="headerlink" href="#injecting-optional-flags" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> API allows querying the value as an <cite>Option</cite>, where <cite>None</cite> means a Flag was neither
supplied via CLI nor had a default value. To replicate this functionality and allow users to define
their flags without a forced default, Finatra binds such flags as both <cite>scala.Option[T]</cite> or
<cite>java.util.Optional[T]</cite>, in addition to just <cite>T</cite>. Note: if a Flag had a default value, it’s only
bound as <cite>T</cite>.</p>
<p>Rephrasing the example from above:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.foo.bar.</span><span class="o">{</span><span class="nc">ForthPartyFoo</span><span class="o">,</span> <span class="nc">ThirdPartyFoo</span><span class="o">,</span> <span class="nc">XPartyFoo</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.google.inject.Provides</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">MyModule1</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="n">flag</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">name</span> <span class="k">=</span> <span class="s">&quot;key&quot;</span><span class="o">,</span> <span class="n">help</span> <span class="k">=</span> <span class="s">&quot;The key to use&quot;</span><span class="o">)</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideXPartyFoo</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="n">myKey</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">XPartyFoo</span> <span class="o">=</span> <span class="n">myKey</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">ThirdPartyFoo</span><span class="o">(</span><span class="n">v</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">ForthPartyFoo</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.foo.bar.ThirdPartyFoo</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.foo.bar.ForthPartyFoo</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Provides</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span><span class="o">;</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">MyModule1</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="n">public</span> <span class="nc">MyModule1</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">createMandatoryFlag</span><span class="o">(</span>
      <span class="cm">/* name      = */</span> <span class="s">&quot;key&quot;</span><span class="o">,</span>
      <span class="cm">/* help      = */</span> <span class="s">&quot;The key to use&quot;</span><span class="o">,</span>
      <span class="cm">/* usage     = */</span> <span class="s">&quot;Pass -key=value&quot;</span><span class="o">,</span>
      <span class="cm">/* flaggable = */</span> <span class="nc">Flaggable</span><span class="o">.</span><span class="n">ofString</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="n">public</span> <span class="nc">XPartyFoo</span> <span class="n">provideXPartyFoo</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">)</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">myKey</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">myKey</span><span class="o">.</span><span class="n">isPresent</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">ThirdPartyFoo</span><span class="o">(</span><span class="n">myKey</span><span class="o">.</span><span class="n">get</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">ForthPartyFoo</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="modules-depending-on-other-modules-flags-edition">
<h2>Modules Depending on Other Modules - Flags Edition<a class="headerlink" href="#modules-depending-on-other-modules-flags-edition" title="Permalink to this headline">¶</a></h2>
<p>As we saw in the <a class="reference external" href="modules.html#modules-depending-on-other-modules">Modules section</a>, Modules can
“depend” on other Modules. In that case we wanted an already bound type for use in another Module.</p>
<p>Flags are special since they are bound to the object graph by the framework due to the fact that
their values are parsed from the command line at a specific point in the server lifecycle. But the
principle is the same. What if we have a Module which defines a configuration Flag that is useful
in other contexts?</p>
<p>As an example, let’s assume we have a Module which defines a Flag for the service’s “Client Id”
String – how it identifies itself as a client to other services – that is necessary for
constructing different clients:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>

<span class="k">object</span> <span class="nc">ClientIdModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="n">flag</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;client.id&quot;</span><span class="o">,</span> <span class="s">&quot;System-wide client id for identifying this server as a client to other services.&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You could choose to build and provide every client which needs the <cite>client.id</cite> Flag value in the
same Module, e.g.,</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.google.inject.Provides</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">ClientsModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">clientIdFlag</span> <span class="k">=</span> <span class="n">flag</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;client.id&quot;</span><span class="o">,</span> <span class="s">&quot;System-wide client id for identifying this server as a client to other services.&quot;</span><span class="o">)</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideClientA</span><span class="k">:</span> <span class="kt">ClientA</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ClientA</span><span class="o">(</span><span class="n">clientIdFlag</span><span class="o">())</span>
  <span class="o">}</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideClientB</span><span class="k">:</span> <span class="kt">ClientB</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ClientB</span><span class="o">(</span><span class="n">clientIdFlag</span><span class="o">())</span>
  <span class="o">}</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideClientC</span><span class="k">:</span> <span class="kt">ClientC</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ClientA</span><span class="o">(</span><span class="n">clientIdFlag</span><span class="o">())</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>But this starts to break down as your add more clients, especially if each client in turn requires
specific configuration or Flags in order to be constructed. For the purposes of encapsulation, we’d
want to collocate all the relevant Flags and logic to create a given client into it’s own re-usable
Module, thus allowing them to be used and tested independently.</p>
<p>If we do so, then how do we get access to the parsed <cite>client.id</cite> Flag value from the <cite>ClientIdModule</cite>
inside of another Module?</p>
<p>Most often you are trying to inject the Flag value into a class using the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a>
<a class="reference external" href="binding_annotations.html">binding annotation</a> on a class constructor-arg. E.g.,</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.</span><span class="o">{</span><span class="nc">Inject</span><span class="o">,</span> <span class="nc">Singleton</span><span class="o">}</span>

<span class="nd">@Singleton</span>
<span class="k">class</span> <span class="nc">MyClassFoo</span> <span class="nd">@Inject</span><span class="o">()</span> <span class="o">(</span>
  <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;client.id&quot;</span><span class="o">)</span> <span class="n">clientId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">???</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You can do something similar in a Module. However, instead of the injection point being the
constructor annotated with <code class="docutils literal notranslate"><span class="pre">&#64;Inject</span></code>, it is the argument list of any <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code>-annotated
method.</p>
<p>E.g.,</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ClientIdModule</span>
<span class="k">import</span> <span class="nn">com.google.inject.</span><span class="o">{</span><span class="nc">Module</span><span class="o">,</span> <span class="nc">Provides</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">ClientAModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">modules</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Module</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">ClientIdModule</span><span class="o">)</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideClientA</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;client.id&quot;</span><span class="o">)</span> <span class="n">clientId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ClientA</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ClientA</span><span class="o">(</span><span class="n">clientId</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>of in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ClientIdModule$</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Module</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Provides</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span><span class="o">;</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">ClientAModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Module</span><span class="o">&gt;</span> <span class="n">javaModules</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="n">singletonList</span><span class="o">((</span>
        <span class="nc">ClientIdModule</span><span class="n">$</span><span class="o">.</span><span class="nc">MODULE</span><span class="n">$</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="n">public</span> <span class="nc">ClientA</span> <span class="n">provideClientA</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;client.id&quot;</span><span class="o">)</span> <span class="nc">String</span> <span class="n">clientId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">ClientA</span><span class="o">(</span><span class="n">clientId</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>What’s happening here?</p>
<p>Firstly, we’ve defined a <cite>ClientAModule</cite> and override the <cite>modules</cite> val to be a <cite>Seq</cite> of Modules
that includes the <cite>ClientIdModule</cite>. This guarantees that if the <cite>ClientIdModule</cite> is not mixed into
the list of Modules for a server, the <cite>ClientAModule</cite> ensures it will be installed since it’s
declared as a dependency.</p>
<p>This ensures that there will be a bound value for the <cite>ClientId</cite> Flag. Otherwise, our Module
definition is brittle in that we are trying to make use of a Flag which may never be defined
within the scope of our server. With TwitterUtil Flags, trying to use an undefined Flag
<a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flags.scala#L118">could cause your server to fail to start</a>.</p>
<p>Thus we want to ensure that:</p>
<ol class="loweralpha simple">
<li>we are only using Flags we define in our Module or</li>
<li>we include the Module that does.</li>
</ol>
<p>Note that it is an <a class="reference external" href="https://github.com/twitter/util/blob/1dd3e6228162c78498338b1c3aa11afe2f8cee22/util-app/src/main/scala/com/twitter/app/Flags.scala#L251">error to try to define the same Flag twice</a>.</p>
<p>Finatra will de-dupe all Modules before installing, so it is OK if a Module appears twice in the
server configuration, though you should strive to make this the exception.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>Reminder: It is important that the framework install all <cite>TwitterModules</cite> such that the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModuleLifecycle.scala">lifecycle functions</a>
are executed in the proper sequence and any <cite>TwitterModule</cite> defined <a class="reference external" href="flags.html">Flags</a> are
parsed properly.</p>
<p class="last">Thus users SHOULD NOT install a <cite>TwitterModule</cite> within another Module via <a class="reference external" href="https://google.github.io/guice/api-docs/4.2/javadoc/com/google/inject/Binder.html#install-com.google.inject.Module-">Module#configure
using `Binder#install</a>.</p>
</div>
<p>Secondly, we’ve defined a method which provides a <cite>ClientA</cite>. Since injection is by type (and the
argument list to an <code class="docutils literal notranslate"><span class="pre">&#64;Provides</span></code> annotated method in a Module is an injection point) and <cite>String</cite>
is not specific enough we use the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/java/com/twitter/inject/annotations/Flag.java"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code></a> <a class="reference external" href="binding_annotations.html">binding annotation</a>.</p>
<p>We could continue this through another Module. For example, if we wanted to provide a <cite>ClientB</cite>
which needs both the <cite>ClientId</cite> and a <cite>ClientA</cite> we could define a <cite>ClientBModule</cite>:</p>
<div class="code scala highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ClientIdModule</span>
<span class="k">import</span> <span class="nn">ClientAModule</span>
<span class="k">import</span> <span class="nn">com.google.inject.</span><span class="o">{</span><span class="nc">Module</span><span class="o">,</span> <span class="nc">Provides</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span>

<span class="k">object</span> <span class="nc">ClientBModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">modules</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Module</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="nc">ClientIdModule</span><span class="o">,</span>
    <span class="nc">ClientAModule</span><span class="o">)</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="n">provideClientB</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;client.id&quot;</span><span class="o">)</span> <span class="n">clientId</span><span class="o">,</span>
    <span class="n">clientA</span><span class="k">:</span> <span class="kt">ClientA</span><span class="o">)</span><span class="k">:</span> <span class="kt">ClientB</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">ClientB</span><span class="o">(</span><span class="n">clientId</span><span class="o">,</span> <span class="n">clientA</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>or in Java:</p>
<div class="code java highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">ClientIdModule$</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Module</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.google.inject.Provides</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.TwitterModule</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.twitter.inject.annotations.Flag</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">javax.inject.Singleton</span><span class="o">;</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">ClientBModule</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Module</span><span class="o">&gt;</span> <span class="n">javaModules</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="n">unmodifiableList</span><span class="o">(</span>
      <span class="nc">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="o">(</span>
        <span class="nc">ClientIdModule</span><span class="n">$</span><span class="o">.</span><span class="nc">MODULE</span><span class="n">$</span><span class="o">,</span>
        <span class="nc">ClientAModule</span><span class="n">$</span><span class="o">.</span><span class="nc">MODULE</span><span class="n">$</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="n">public</span> <span class="nc">ClientB</span> <span class="n">provideClientB</span><span class="o">(</span>
    <span class="nd">@Flag</span><span class="o">(</span><span class="s">&quot;client.id&quot;</span><span class="o">)</span> <span class="n">clientId</span><span class="o">,</span>
    <span class="n">clientA</span><span class="k">:</span> <span class="kt">ClientA</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">ClientB</span><span class="o">(</span><span class="n">clientId</span><span class="o">,</span> <span class="n">clientA</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Notice that we choose to include both the <cite>ClientIdModule</cite> and <cite>ClientAModule</cite> in the list of Modules
for the <cite>ClientBModule</cite>. Yet, since we know that the <cite>ClientAModule</cite> includes the <cite>ClientIdModule</cite>
we could have chosen to leave it out.</p>
<p>The <cite>provideClientB</cite> method in the Module above takes in both a <cite>ClientId</cite> String and a <cite>ClientA</cite>.
Since it declares the two Modules, we’re assured that these types will be available from the
Injector for our <cite>provideClientB</cite> method to use.</p>
</div>
<div class="section" id="this-is-just-an-example">
<h2>This is just an Example<a class="headerlink" href="#this-is-just-an-example" title="Permalink to this headline">¶</a></h2>
<p>Note that usage of a <cite>client.id</cite> Flag is just an example. In Finatra, we provide a
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-thrift-client/src/main/scala/com/twitter/inject/thrift/modules/ThriftClientIdModule.scala">ThriftClientIdModule</a>
for binding a <cite>c.t.finagle.thrift.ClientId</cite> type so that you do not need to rely on the Flag value.</p>
<p>You’ll see that this type is then expected to be bound in other Modules like the
<a class="reference external" href="https://github.com/twitter/finatra/blob/ec8d584eb914f50f92314c740dc68fb7abb47eff/inject/inject-thrift-client/src/main/scala/com/twitter/inject/thrift/modules/FilteredThriftClientModule.scala#L234">FilteredThriftClientModule</a>
which is a utility for building filtered thrift clients.</p>
<p>The framework does not assume that you are using the
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-thrift-client/src/main/scala/com/twitter/inject/thrift/modules/ThriftClientIdModule.scala">ThriftClientIdModule</a>
for providing the bound <cite>ClientId</cite> type thus the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-thrift-client/src/main/scala/com/twitter/inject/thrift/modules/FilteredThriftClientModule.scala">FilteredThriftClientModule</a>
does <strong>not</strong> specify the <cite>ThriftClientIdModule</cite> in it’s list of Modules to allow users to bind an
instance of the <cite>ClientId</cite> type in any manner they choose.</p>
</div>
<div class="section" id="passing-flag-values-as-command-line-arguments">
<h2>Passing Flag Values as Command-Line Arguments<a class="headerlink" href="#passing-flag-values-as-command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>Flags are set by passing them as arguments to your java application. E.g.,</p>
<div class="code bash highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">$</span> <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">finatra</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">assembly</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="mf">0.</span><span class="n">jar</span> <span class="o">-</span><span class="n">key</span><span class="k">=</span><span class="n">value</span>
</pre></div>
</div>
<p>An example of this is passing the <cite>-help</cite> Flag to see usage for running a Finatra server, e.g.</p>
<div class="code bash highlight-scala notranslate"><div class="highlight"><pre><span></span>$ java -jar finatra-http-server-assembly-2.0.0.jar -help
HelloWorldServer
  -alarm_durations=&#39;1.seconds,5.seconds&#39;: 2 alarm durations
  -help=&#39;false&#39;: Show this help
  -admin.port=&#39;:8080&#39;: Admin http server port
  -bind=&#39;:0&#39;: Network interface to use
  -log.level=&#39;INFO&#39;: Log level
  -log.output=&#39;/dev/stderr&#39;: Output file
  -key=&#39;default&#39;: The key to use
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>Best Practices<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Prefer defining Flags as <em>granular</em> as possible. i.e., do not define an “environment” Flag which is
then used to choose application functionality in code. It is considered best practice
to keep configuration separated from code [<a class="reference external" href="https://12factor.net/config">1</a>, <a class="reference external" href="https://microservices.io/patterns/externalized-configuration.html">2</a>, <a class="reference external" href="https://dzone.com/articles/microservices-externalized-configuration">3</a>].</li>
<li>Prefer to define all Flags which help to configure an application resource in the <cite>TwitterModule</cite>
which provides the resource to the object graph.</li>
<li>Do not hold a reference to a created Flag unless necessary. Prefer obtaining the parsed Flag
value from the Injector.</li>
<li>If you have a lot of external configuration and your deployment system does not provide ways to
manage a large amount of application parameters, consider <a class="reference external" href="#but-i-have-a-lot-of-flags">other mechanisms</a>
for reading and parsing external configuration. But prefer to keep the application configuration
externalized and not moved into the code.</li>
<li>Make use of the <a class="reference external" href="../testing/integration_tests.html#id2">TestInjector</a> for integration testing
with <cite>TwitterModules</cite> as this will correctly handle the lifecycle and Flag parsing of
<cite>TwitterModules</cite> to create a <cite>c.t.inject.Injector</cite>.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Flags</a><ul>
<li><a class="reference internal" href="#global-flags">Global Flags</a></li>
<li><a class="reference internal" href="#but-i-have-a-lot-of-flags">But I have a lot of Flags</a></li>
<li><a class="reference internal" href="#when-are-flags-parsed">When Are Flags Parsed?</a><ul>
<li><a class="reference internal" href="#c-t-app-app-failfastonflagsnotparsed"><cite>c.t.app.App#failfastOnFlagsNotParsed</cite></a><ul>
<li><a class="reference internal" href="#modules">Modules</a></li>
<li><a class="reference internal" href="#flags-with-no-command-line-value">Flags With No Command Line Value</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-define-flags">How To Define Flags</a><ul>
<li><a class="reference internal" href="#within-an-app-or-a-server">Within an App or a Server</a></li>
<li><a class="reference internal" href="#within-a-twittermodule">Within a TwitterModule</a><ul>
<li><a class="reference internal" href="#flag-annotation"><code class="docutils literal notranslate"><span class="pre">&#64;Flag</span></code> annotation</a></li>
<li><a class="reference internal" href="#understanding-flag-binding">Understanding Flag Binding</a></li>
<li><a class="reference internal" href="#holding-a-reference">Holding a Reference</a><ul>
<li><a class="reference internal" href="#caution">Caution</a></li>
<li><a class="reference internal" href="#even-more-caution">Even More Caution</a></li>
<li><a class="reference internal" href="#ok-but-i-want-to-live-dangerously">Ok, But I Want To Live Dangerously</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">Flag Value Injection</a></li>
<li><a class="reference internal" href="#flag-value-injection-benefits">Flag Value Injection Benefits</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#flags-without-defaults">Flags Without Defaults</a><ul>
<li><a class="reference internal" href="#injecting-optional-flags">Injecting Optional Flags</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modules-depending-on-other-modules-flags-edition">Modules Depending on Other Modules - Flags Edition</a></li>
<li><a class="reference internal" href="#this-is-just-an-example">This is just an Example</a></li>
<li><a class="reference internal" href="#passing-flag-values-as-command-line-arguments">Passing Flag Values as Command-Line Arguments</a></li>
<li><a class="reference internal" href="#id4">Best Practices</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="binding_annotations.html" title="previous chapter">Binding Annotations</a></li>
      <li>Next: <a href="futures.html" title="next chapter">Future Gotchas</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2022 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>